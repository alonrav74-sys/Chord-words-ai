<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChordFinder Pro v3.0 - Test</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #0b1022; color: #fff; }
    .panel { background: #1a1a2e; padding: 20px; margin: 10px 0; border-radius: 8px; }
    button { padding: 10px 20px; margin: 5px; background: #22c55e; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .chord { font-size: 48px; font-weight: bold; color: #22c55e; }
    .timeline { font-family: monospace; white-space: pre; background: #0a0a0a; padding: 10px; border-radius: 6px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>🎸 ChordFinder Pro v3.0 (Test)</h1>
  <p>מנגנון חדש מודולרי עם הקוד המוכח מ-v10!</p>

  <div class="panel">
    <h2>העלאת קובץ</h2>
    <input type="file" id="fileInput" accept="audio/*,video/*">
    <br><br>
    <label>
      מצב:
      <select id="modeSelect">
        <option value="balanced">Balanced</option>
        <option value="accurate">Accurate (Pro)</option>
      </select>
    </label>
    <br><br>
    <button id="analyzeBtn">נתח</button>
    <button id="playBtn" disabled>▶️ נגן</button>
  </div>

  <div class="panel">
    <h2>תוצאות</h2>
    <div id="status">—</div>
    <div id="key">סולם: —</div>
    <div id="bpm">BPM: —</div>
  </div>

  <div class="panel">
    <h2>אקורד נוכחי</h2>
    <div class="chord" id="currentChord">—</div>
  </div>

  <div class="panel">
    <h2>Timeline</h2>
    <div class="timeline" id="timeline">—</div>
  </div>

  <audio id="player" controls style="width: 100%; margin-top: 10px;"></audio>

  <!-- Load modules in order: BASE → ENGINE → PRO -->
  <script src="chord-engine-base.js"></script>
  <script src="chord-engine.js"></script>
  <script src="chord-engine-pro.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const playBtn = document.getElementById('playBtn');
    const modeSelect = document.getElementById('modeSelect');
    const statusEl = document.getElementById('status');
    const keyEl = document.getElementById('key');
    const bpmEl = document.getElementById('bpm');
    const currentChordEl = document.getElementById('currentChord');
    const timelineEl = document.getElementById('timeline');
    const player = document.getElementById('player');

    let STATE = null;

    analyzeBtn.onclick = async () => {
      const file = fileInput.files[0];
      if (!file) {
        alert('בחר קובץ אודיו');
        return;
      }

      try {
        statusEl.textContent = '⏳ מנתח...';
        analyzeBtn.disabled = true;

        // Choose engine based on mode
        const mode = modeSelect.value;
        const engine = mode === 'accurate' ? new ChordEnginePro() : new ChordEngine();

        // Step 1: Decode audio
        statusEl.textContent = '[1/2] טעינת אודיו...';
        const audioData = await engine.decodeAudio(file);
        
        // Step 2: Analyze
        statusEl.textContent = '[2/2] מנתח אקורדים...';
        const result = await engine.analyze(audioData, mode);

        // Save state
        STATE = result;

        // Display results
        statusEl.textContent = '✅ ניתוח הושלם!';
        keyEl.textContent = `סולם: ${engine.nameSharp(result.key.root)}${result.key.minor ? 'm' : ''}`;
        bpmEl.textContent = `BPM: ${result.bpm}`;

        // Display timeline
        let timelineText = '';
        for (const ev of result.timeline) {
          timelineText += `${ev.t.toFixed(2)}s  ${ev.label}\n`;
        }
        timelineEl.textContent = timelineText;

        // Setup audio
        const url = URL.createObjectURL(file);
        player.src = url;
        playBtn.disabled = false;

        // Live tracking
        player.ontimeupdate = () => {
          const t = player.currentTime;
          let i = STATE.timeline.findIndex(x => x.t > t);
          if (i === -1) i = STATE.timeline.length;
          const ev = STATE.timeline[i - 1] || STATE.timeline[0];
          if (ev) {
            currentChordEl.textContent = ev.label;
          }
        };

      } catch (e) {
        statusEl.textContent = '❌ שגיאה: ' + e.message;
        console.error(e);
      } finally {
        analyzeBtn.disabled = false;
      }
    };

    playBtn.onclick = () => {
      player.play();
    };
  </script>
</body>
</html>
