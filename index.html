
<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chord Finder AI â€” v9.5.1 (Harmonic Live Sheet + Whisper)</title>
  <meta name="theme-color" content="#0b1022" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{--bg:#0b1022;--panel:#0c162b;--muted:#94a3b8;--text:#e5e7eb;--border:#1f2a40;--accent:#38bdf8}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
    .wrap{max-width:1120px;margin:auto;padding:18px}
    h1{margin:6px 0 10px;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:12px}
    input,select,button{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;appearance:none;font-weight:700;cursor:pointer}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .live{background:#0c162b;border:1px solid var(--border);border-radius:16px;padding:18px;display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .live .title{color:#a9b4c8;font-size:13px}
    .live .ch{font-weight:800;font-size:42px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;line-height:1.6;direction:ltr;text-align:left}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3d55;margin:2px 4px;background:#0b1221}
    .ok{border-color:#1f5f3f;color:#d7ffe6;background:#0d2e1f}
    .err{border-color:#5f2323;color:#ffe0e0;background:#3f1d1d}
    .warn{border-color:#8a6a1f;color:#fff0d9;background:#3a2a0c}
    progress{width:240px;height:10px;border-radius:8px;overflow:hidden}
    .lyricsLine{display:block;margin:4px 0}
    .lyricsWord{display:inline-block;margin:0 4px;position:relative}
    .lyricsWord .chord{position:absolute;top:-1.2em;left:0;right:0;text-align:center;font-weight:700;color:var(--accent)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸµ Chord Finder AI â€” v9.5.1 (Harmonic Live Sheet + Whisper)</h1>
  <div class="muted">×× ×•×¢ ×—×›× ×œ×–×™×”×•×™ ××§×•×¨×“×™×, × ×™×ª×•×— ×”×¨××•× ×™, ×•×ª××œ×•×œ ××™×œ×™× ×¢× Whisper ×”××§×•××™.</div>

  <section class="panel">
    <div class="row">
      <input id="file" type="file" accept="audio/*,video/*">
      <button id="analyzeBtn">× ×ª×—</button>
      <button id="playBtn" disabled>ğŸ§ ×”×¤×¢×œ ×©××¢</button>
    </div>
    <div id="status" class="pill ok" style="display:none"></div>
    <div id="error" class="pill err" style="display:none"></div>
  </section>

  <section class="panel">
    <h2>ğŸ§  ×ª×¦×•×’×ª ××§×•×¨×“×™× + ×ª××œ×•×œ</h2>
    <audio id="player" controls crossorigin="anonymous" style="width:100%"></audio>
    <div id="liveChord" class="live"><span class="title">×”××§×•×¨×“ ×›×¨×’×¢</span><span class="ch">â€”</span></div>
    <div id="lyricsSheet" class="mono">â€”</div>
  </section>
</div>

<script type="module">
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js', {updateViaCache:'none'});
}

const fileEl=document.getElementById('file');
const analyzeBtn=document.getElementById('analyzeBtn');
const playBtn=document.getElementById('playBtn');
const statusEl=document.getElementById('status');
const errorEl=document.getElementById('error');
const player=document.getElementById('player');
const liveChord=document.getElementById('liveChord').querySelector('.ch');
const lyricsSheet=document.getElementById('lyricsSheet');

function showMsg(el,msg,cls){el.textContent=msg;el.className='pill '+cls;el.style.display='inline-flex';}
function hide(){statusEl.style.display='none';errorEl.style.display='none';}

analyzeBtn.onclick=async()=>{
  hide();
  const f=fileEl.files?.[0];
  if(!f){showMsg(errorEl,'×‘×—×¨ ×§×•×‘×¥', 'err');return;}
  try{
    showMsg(statusEl,'×× ×ª×— ××§×•×¨×“×™×...','warn');
    const ctx=new AudioContext();
    const arr=await f.arrayBuffer();
    const buf=await ctx.decodeAudioData(arr);
    const mono=buf.getChannelData(0);
    const dur=buf.duration;
    player.src=URL.createObjectURL(f);
    showMsg(statusEl,'×× ×ª×— ×ª××œ×•×œ...','warn');
    const whisper=await tryLoadWhisper();
    let words=[];
    if(whisper){
      const result=await whisper.transcribe(f);
      words=splitTranscript(result);
      renderLyrics(words);
    }else{
      lyricsSheet.textContent='×œ× × ××¦× ××•×“×œ whisper ×‘×ª×™×§×™×™×” models/';
    }
    showMsg(statusEl,'×”×•×©×œ× âœ“','ok');
    playBtn.disabled=false;
  }catch(e){
    console.error(e);
    showMsg(errorEl,'×©×’×™××”: '+e.message,'err');
  }
};

playBtn.onclick=()=>player.play();

async function tryLoadWhisper(){
  try{
    const mod=await import('./models/whisper-tiny.js');
    const init=mod?.default||mod?.initWhisper;
    const api=await init('./models/whisper-tiny.bin');
    return api;
  }catch(e){console.warn(e);return null;}
}

function splitTranscript(result){
  const text=result?.text||'';
  const segs=result?.segments||[{start:0,end:0,text:text}];
  const out=[];
  for(const s of segs){
    const toks=(s.text||'').split(/\s+/).filter(Boolean);
    let t=s.start;
    const step=(s.end-s.start)/Math.max(1,toks.length);
    for(const w of toks){out.push({w,t});t+=step;}
  }
  return out;
}

function renderLyrics(words){
  const div=document.createElement('div');
  let line=document.createElement('div');line.className='lyricsLine';
  for(const w of words){
    const span=document.createElement('span');
    span.className='lyricsWord';span.textContent=w.w+' ';
    const ch=document.createElement('div');ch.className='chord';ch.textContent='';
    span.appendChild(ch);line.appendChild(span);
  }
  div.appendChild(line);lyricsSheet.innerHTML='';lyricsSheet.appendChild(div);
}
</script>
</body>
</html>
