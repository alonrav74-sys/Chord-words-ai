<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>🎧 YouTube Audio Loader — Safe Fallback</title>
<style>
body{background:#0b1022;color:#e5e7eb;font-family:system-ui;padding:24px;text-align:center}
h1{font-size:22px;margin-bottom:14px}
input,button{padding:10px 14px;border-radius:8px;border:1px solid #223;background:#0f172a;color:#e5e7eb;font-weight:600}
button{cursor:pointer}
.err{background:#3f1d1d;color:#ffbaba;padding:8px;border-radius:8px}
.ok{background:#0d2e1f;color:#d7ffe6;padding:8px;border-radius:8px}
.loading{color:#facc15}
</style>
</head>
<body>

<h1>🔊 טעינה מיוטיוב עם חילוץ אודיו (גרסה עם Fallbacks)</h1>

<input id="ytUrl" placeholder="הדבק קישור YouTube..." style="width:80%">
<button id="loadBtn">🎧 חלץ אודיו</button>
<div id="status" style="margin-top:12px"></div>
<audio id="player" controls style="width:100%;margin-top:20px"></audio>

<script type="module">
const ytUrl=document.getElementById('ytUrl');
const loadBtn=document.getElementById('loadBtn');
const status=document.getElementById('status');
const player=document.getElementById('player');

// === שלוש שכבות fallback ===
const API_SOURCES=[
  id=>`https://pipedapi.kavin.rocks/streams/${id}`,
  id=>`https://corsproxy.io/?https://pipedapi.kavin.rocks/streams/${id}`,
  id=>`https://api.allorigins.win/raw?url=${encodeURIComponent('https://pipedapi.kavin.rocks/streams/'+id)}`
];

// === חילוץ מזהה הווידאו ===
function extractVideoId(url){
  url=url.trim();
  if(url.includes('youtu.be/')) return url.split('youtu.be/')[1].split('?')[0];
  if(url.includes('v=')) return url.split('v=')[1].split('&')[0];
  return url.split('/').pop();
}

// === נסיון בשלבים ===
async function tryFetchJson(urls){
  for(const u of urls){
    try{
      const res=await fetch(u);
      if(res.ok){
        const js=await res.json();
        if(js?.audioStreams?.length) return js;
      }
    }catch(e){console.warn('❌',u);}
  }
  throw new Error('כל השרתים נכשלו');
}

loadBtn.onclick=async()=>{
  const val=ytUrl.value.trim();
  if(!val){status.innerHTML='<div class="err">הדבק קישור תחילה</div>';return;}
  const id=extractVideoId(val);
  status.innerHTML='<div class="loading">⏳ טוען מידע מיוטיוב...</div>';
  try{
    const info=await tryFetchJson(API_SOURCES.map(f=>f(id)));
    const stream=info.audioStreams.find(s=>s.mimeType.includes('audio/mp4'))?.url
      || info.audioStreams.find(s=>s.url)?.url;
    if(!stream) throw new Error('לא נמצא סטרים אודיו');
    player.src=stream;
    await player.play().catch(()=>{});
    status.innerHTML='<div class="ok">✅ אודיו נטען בהצלחה!</div>';
  }catch(e){
    console.error(e);
    status.innerHTML='<div class="err">❌ שגיאה בשליפת סטרים אודיו</div>';
  }
};
</script>
</body>
</html>